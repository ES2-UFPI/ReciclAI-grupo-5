{% extends 'base.html' %}
{% load static %}

{% block title %}Solicitar Coleta - {{ block.super }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<style>
    #map {
        height: 400px;
        border-radius: 8px;
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header">
                    <h2>Solicitar Nova Coleta</h2>
                    <p>Preencha os dados do resíduo e selecione no mapa o local exato para a coleta.</p>
                </div>
                <div class="card-body">
                    <form method="post" novalidate>
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {% for error in form.non_field_errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}

                        {{ form.latitude.as_hidden }}
                        {{ form.longitude.as_hidden }}

                        {% for field in form.visible_fields %}
                            <div class="mb-3">
                                <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                                {{ field }}
                                {% if field.help_text %}
                                    <small class="form-text text-muted">{{ field.help_text }}</small>
                                {% endif %}
                                {% for error in field.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ error }}
                                    </div>
                                {% endfor %}
                            </div>
                        {% endfor %}
                        
                        <div id="map"></div>
                        
                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-primary">Solicitar Coleta</button>
                            <a href="{% url 'reciclAI:residue_list' %}" class="btn btn-secondary">Cancelar</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Insira sua chave de API do Mapbox aqui
    const MAPBOX_ACCESS_TOKEN = 'pk.eyJ1IjoicmVjaWNsYWkiLCJhIjoiY2x4d3k2d3gwMGR2eDJrcW1yMGg3cnl0eSJ9.57s-D-8d-z-8-g';

    // Coordenadas iniciais (ex: centro de uma cidade)
    const initialCoords = [-23.5505, -46.6333];

    const map = L.map('map').setView(initialCoords, 13);

    L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
        maxZoom: 18,
        id: 'mapbox/streets-v11',
        tileSize: 512,
        zoomOffset: -1,
        accessToken: MAPBOX_ACCESS_TOKEN
    }).addTo(map);

    let marker;

    map.on('click', function(e) {
        const { lat, lng } = e.latlng;
        
        // Remove o marcador anterior, se existir
        if (marker) {
            map.removeLayer(marker);
        }
        
        // Adiciona um novo marcador no local do clique
        marker = L.marker([lat, lng]).addTo(map);
        
        // Atualiza os campos ocultos do formulário com as coordenadas
        document.getElementById('id_latitude').value = lat.toFixed(6);
        document.getElementById('id_longitude').value = lng.toFixed(6);

        // Opcional: Anima o scroll para o botão de submit para melhor UX
        document.querySelector('button[type="submit"]').scrollIntoView({ behavior: 'smooth' });
    });

    // Tenta obter a localização do usuário para centralizar o mapa
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const userCoords = [position.coords.latitude, position.coords.longitude];
            map.setView(userCoords, 15);
        }, function() {
            console.warn('Não foi possível obter a geolocalização. O mapa iniciará no local padrão.');
        });
    }
});
</script>
{% endblock %}
